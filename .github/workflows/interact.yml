#è§¦å‘ï¼šIssue è¢«åˆ›å»ºï¼ˆopenedï¼‰
name: ç”¨æˆ·äº¤äº’ (Interact)

on:
  issues:
    types: [opened]  # å½“ Issue è¢«åˆ›å»ºæ—¶è§¦å‘

jobs:
  interact:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write      # éœ€è¦å†™å…¥æƒé™æ¥æäº¤æ–‡ä»¶
      issues: write        # éœ€è¦åœ¨ Issue ä¸­æ·»åŠ è¯„è®º
      pull-requests: none  # ä¸éœ€è¦ PR æƒé™
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: è¿è¡Œäº¤äº’è„šæœ¬
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          python3 scripts/interact.py
      - name: æ›´æ–° README
        run: |
          python3 scripts/readme_update.py
      
      - name: è¯»å–åé¦ˆæ¶ˆæ¯
        id: read_response
        run: |
          if [ -f "$GITHUB_STEP_SUMMARY" ]; then
            RESPONSE=$(cat $GITHUB_STEP_SUMMARY)
          else
            RESPONSE=$(cat /tmp/response.md 2>/dev/null || echo "## âœ… æŒ‡ä»¤å·²æ‰§è¡Œ\nçŠ¶æ€å·²æ›´æ–°ã€‚")
          fi
          # ä½¿ç”¨å¤šè¡Œè¾“å‡º
          {
            echo 'response<<EOF'
            echo "$RESPONSE"
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: åœ¨ Issue ä¸­æ·»åŠ è¯„è®º
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = `${{ steps.read_response.outputs.response }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });
      
      - name: æäº¤çŠ¶æ€æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/state.json README.md
          git diff --staged --quiet || git commit -m "ğŸ® ç”¨æˆ·äº¤äº’ï¼š${{ github.event.issue.title }} [skip ci]"
          git push